<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.b2.Sinnanda.mapper.HostMapper">

<!-- #인덱스 (작성자 : 이승준)
	1. 조회
		selectHostPw
		selectHostOne
		selectHostOneWithAddress
		
	2. 삽입
		insertHost
		insertHostAdress
		
	3. 수정
		updateHost
		updateHostPw
		
	4. 삭제
		deleteHost
		
 -->

<!-- 1. 조회 -->

	<!-- [이승준] (상세)"사업자 비밀번호" 조회 -->
	<select id="selectHostPw" parameterType="int" resultType="String">
		SELECT 
			host_pw hostPw
		FROM host
		WHERE host_no = #{hostNo}
	</select>

	<!-- [이승준] (상세)"사업자 상세" 조회 -->
	<select id="selectHostOne" parameterType="int">
		SELECT 
			host_no hostNo, 
			host_id hostId, 
			host_name hostName, 
			host_tel hostTel, 
			host_active hostActive, 
			member_level memberLevel, 
			create_date createDate, 
			update_date updateDate
		FROM host
		WHERE host_no = #{hostNo}
	</select>
	
	<!-- [이승준] (상세)"사업자 상세+주소" 조회 resultMap -->
	<resultMap type="com.b2.Sinnanda.vo.Host" id="hostOneWithAddressMap">
		<id column="host_no" property="hostNo"/>
		<result column="host_id" property="hostId"/>
		<result column="host_name" property="hostName"/>
		<result column="host_tel" property="hostTel"/>
		<result column="host_active" property="hostActive"/>
		<result column="member_level" property="memberLevel"/>
		<result column="create_date" property="createDate"/>
		<result column="update_date" property="updateDate"/>
		
		<collection property="hostAddress" ofType="com.b2.Sinnanda.vo.HostAddress" resultMap="hostAddressMap"></collection>
	</resultMap>
	<!-- 사업자에 대한 주소 resultMap -->
	<resultMap id="hostAddressMap" type="com.b2.Sinnanda.vo.HostAddress">
		<result column="address_detail" property="addressDetail"/>
		
		<collection property="address" ofType="com.b2.Sinnanda.vo.Address" resultMap="hostAddressDetailMap"></collection>
	</resultMap>
	<!-- 사업자 주소에 대한 주소 resultMap -->
	<resultMap id="hostAddressDetailMap" type="com.b2.Sinnanda.vo.Address">
		<id column="address_no" property="addressNo"/>
		<result column="sido" property="sido"/>
		<result column="sigungu" property="sigungu"/>
		<result column="road_name" property="roadName"/>
		<result column="main_building_code" property="mainBuildingCode"/>
		<result column="sub_building_code" property="subBuildingCode"/>
	</resultMap>
	<!-- [이승준] (상세)"사업자 상세+주소" 조회 -->
	<select id="selectHostOneWithAddress" parameterType="int" resultMap="hostOneWithAddressMap">
		SELECT 
			h.host_no, 
			h.host_id, 
			h.host_name, 
			h.host_tel, 
			h.host_active, 
			h.member_level, 
			h.create_date, 
			h.update_date,
			ha.address_detail, 
			a.address_no, 
			a.sido, 
			a.sigungu, 
			a.road_name, 
			a.main_building_code, 
			a.sub_building_code
		FROM host h 
			LEFT JOIN host_address ha ON ha.host_no = h.host_no
			LEFT JOIN address a ON a.address_no = ha.address_no
		WHERE h.host_no = #{hostNo}
	</select>
	
		<!-- [이승준] "사업자 PW 확인" 조회 -->
	<select id="selectHostPwCheck" parameterType="com.b2.Sinnanda.vo.Host" resultType="int">
		SELECT COUNT(host_id)
		FROM host
		WHERE host_no = #{hostNo} AND host_pw = #{hostPw}
	</select>


	<!-- [이승준] "사업자" 수정 -->
	<update id="updateHost" parameterType="com.b2.Sinnanda.vo.Host">
		UPDATE host
		SET host_name = #{hostName}, 
			host_tel = #{hostTel}, 
			host_active = #{hostActive}, 
			update_date = NOW()
		WHERE host_no = #{hostQnaNo}
	</update>
	
	<!-- [이승준] "사업자 비밀번호" 수정 -->
	<update id="updateHostPw" parameterType="com.b2.Sinnanda.vo.Host">
		UPDATE host
		SET host_pw = #{hostPw}, 
			update_date = NOW()
		WHERE host_no = #{hostQnaNo}
	</update>
	
	
	
	
	<!--[윤경환] 호스트가 가지고 있는 숙소 종류 -->
	<select id="selectHostAccom" parameterType ="int" resultType="com.b2.Sinnanda.vo.Accom">
		SELECT  
			accom_name accomName,
			host_no hostNo
		FROM accom
		where host_no = #{hostNo}
	</select>
			
			
	<resultMap type="com.b2.Sinnanda.vo.Payment" id="hostAcoomIncome">
		<id column="create_date" property="createDate"/>
		<result column="payment_price" property="paymentPrice"/>
	</resultMap>
			
	<!--[윤경환] 숙소에 따라 사업자가 없는 수익 차트 -->
	<select id="TotalAccomHostYear" parameterType="Map" resultType="java.util.Map">
		SELECT 
			SUM(CASE WHEN MONTH(pa.create_date) =1 THEN pa.payment_price END) january,
			SUM(CASE WHEN MONTH(pa.create_date) =2 THEN pa.payment_price END) february,
			SUM(CASE WHEN MONTH(pa.create_date) =3 THEN pa.payment_price END) march,
			SUM(CASE WHEN MONTH(pa.create_date) =4 THEN pa.payment_price END) april,
			SUM(CASE WHEN MONTH(pa.create_date) =5 THEN pa.payment_price END) may,
			SUM(CASE WHEN MONTH(pa.create_date) =6 THEN pa.payment_price END) june,
			SUM(CASE WHEN MONTH(pa.create_date) =7 THEN pa.payment_price END) july,
			SUM(CASE WHEN MONTH(pa.create_date) =8 THEN pa.payment_price END) august,
			SUM(CASE WHEN MONTH(pa.create_date) =9 THEN pa.payment_price END) september,
			SUM(CASE WHEN MONTH(pa.create_date) =10 THEN pa.payment_price END) october,
			SUM(CASE WHEN MONTH(pa.create_date) =11 THEN pa.payment_price END) november,
			SUM(CASE WHEN MONTH(pa.create_date) =12 THEN pa.payment_price END) december
		FROM payment AS pa
			LEFT JOIN reserve AS re
		ON pa.reserve_no = re.reserve_no
			LEFT JOIN  room  AS ro
		ON re.room_no = ro.room_no
			LEFT join accom  AS ac 
		ON ac.accom_no = ro.accom_no
		WHERE YEAR(pa.create_date)= #{year} 
			AND ac.host_no = #{hostNo}
			<if test="accomName != null">
					AND ac.accom_name = #{accomName}
			</if>
		
	</select>


<!-- 2. 삽입 -->
	
	<!-- [이승준] "사업자" 삽입 -->
	<insert id="insertHost" parameterType="com.b2.Sinnanda.vo.Host">
		INSERT INTO host (
			host_id, 
			host_pw, 
			host_name, 
			host_tel, 
			host_active, 
			create_date, 
			update_date
		) VALUES (
			#{hostId}, 
			#{hostPw}, 
			#{hostName}, 
			#{hostTel}, 
			#{hostActive}, 
			NOW(),
			NOW() 
		)
		<selectKey keyProperty="hostNo" order="AFTER" resultType="int">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	

<!-- 3. 수정 -->
	
	<!-- [이승준] "사업자" 수정 -->
	<update id="updateHost" parameterType="com.b2.Sinnanda.vo.Host">
		UPDATE host
		SET host_name = #{hostName}, 
			host_tel = #{hostTel}, 
			host_active = #{hostActive}, 
			update_date = NOW()
		WHERE host_no = #{hostQnaNo}
	</update>
	
	<!-- [이승준] "사업자 비밀번호" 수정 -->
	<update id="updateHostPw" parameterType="com.b2.Sinnanda.vo.Host">
		UPDATE host
		SET host_pw = #{hostPw}, 
			update_date = NOW()
		WHERE host_no = #{hostQnaNo}
	</update>
	
	
	
<!-- 4. 삭제 -->
	
	
	
	
	
</mapper>